'use client';

import { useState } from 'react';
import { AlertTriangle, XCircle, AlertCircle, Info, ChevronDown, Shield } from 'lucide-react';
import type { Warning } from './types';

/**
 * VulnerabilityList - Interactive Educational Accordion
 * Cyber-security style with expandable explanations
 */

interface VulnerabilityListProps {
  warnings: Warning[];
}

const severityConfig = {
  critical: {
    icon: XCircle,
    iconBg: 'bg-red-500/10',
    iconColor: 'text-red-400',
    borderColor: 'border-red-500/20',
    label: 'Critical',
    glowColor: 'hover:shadow-red-500/10',
  },
  high: {
    icon: AlertTriangle,
    iconBg: 'bg-orange-500/10',
    iconColor: 'text-orange-400',
    borderColor: 'border-orange-500/20',
    label: 'High',
    glowColor: 'hover:shadow-orange-500/10',
  },
  medium: {
    icon: AlertCircle,
    iconBg: 'bg-amber-500/10',
    iconColor: 'text-amber-400',
    borderColor: 'border-amber-500/20',
    label: 'Medium',
    glowColor: 'hover:shadow-amber-500/10',
  },
  low: {
    icon: Info,
    iconBg: 'bg-gray-500/10',
    iconColor: 'text-gray-400',
    borderColor: 'border-gray-500/20',
    label: 'Low',
    glowColor: 'hover:shadow-gray-500/10',
  },
} as const;

/**
 * Get educational content based on issue type
 */
function getEducationalContent(issue: string, category: string): string {
  const issueText = `${issue} ${category}`.toLowerCase();
  
  if (issueText.includes('cex') || issueText.includes('exchange') || issueText.includes('binance') || issueText.includes('coinbase')) {
    return "‚ö†Ô∏è INTELLIGENCE BRIEF: Centralized Exchanges (CEX) require KYC verification. Linking this wallet directly to Binance/Coinbase reveals your real-world identity to anyone analyzing the chain. Your financial sovereignty is compromised. Recommended countermeasure: Use an intermediate privacy layer before interacting with CEX platforms.";
  }
  
  if (issueText.includes('cluster') || issueText.includes('link') || issueText.includes('connect')) {
    return "üîó PATTERN ANALYSIS: You are frequently sending funds between your own wallets. This creates a clear behavioral 'fingerprint', allowing chain observers to map your entire portfolio network. Your wallets are no longer isolated entities‚Äîthey form a traceable cluster that reveals your total holdings and movement patterns.";
  }
  
  if (issueText.includes('poap') || issueText.includes('identity') || issueText.includes('nft') || issueText.includes('badge')) {
    return "üìç LOCATION INTELLIGENCE: Event badges (POAPs) and identity NFTs often prove your physical location at a specific date and time. Combined with social media activity and other on-chain data, this creates a dossier that can potentially deanonymize your real-world identity. Exercise caution when collecting location-based tokens.";
  }
  
  if (issueText.includes('reuse') || issueText.includes('address') || issueText.includes('same wallet')) {
    return "üîÑ OPERATIONAL SECURITY BREACH: Reusing addresses across multiple transactions creates a permanent link between all your activities. Each transaction adds more metadata to your profile. Professional adversaries can reconstruct your entire financial history from a single address exposure.";
  }
  
  if (issueText.includes('dust') || issueText.includes('small amount')) {
    return "üéØ TRACKING ATTEMPT DETECTED: Dust attacks involve sending tiny amounts to your wallet to track its subsequent movements. When you consolidate these small amounts, you reveal wallet connections. Consider these micro-transactions as surveillance beacons.";
  }
  
  // Default intelligence brief
  return "üìã PERMANENT RECORD: This activity creates an immutable record on the blockchain. Every transaction, every interaction is logged forever. Chain analysis firms are constantly mapping wallet behaviors. What seems anonymous today may be fully traceable tomorrow as analysis techniques improve.";
}

export function VulnerabilityList({ warnings }: VulnerabilityListProps) {
  const [expandedId, setExpandedId] = useState<number | null>(null);

  if (warnings.length === 0) {
    return null;
  }

  const toggleExpand = (index: number) => {
    setExpandedId(expandedId === index ? null : index);
  };

  return (
    <div>
      {/* Header - Cyber Security Style */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-3">
          <div className="w-8 h-8 rounded-lg bg-red-500/10 flex items-center justify-center">
            <Shield className="w-4 h-4 text-red-400" />
          </div>
          <div>
            <h2 className="text-lg font-bold text-white/90">Threat Analysis</h2>
            <p className="text-xs text-white/40">Click to expand intelligence brief</p>
          </div>
        </div>
        <div className="px-3 py-1.5 rounded-full bg-red-500/10 border border-red-500/20">
          <span className="text-xs font-mono font-semibold text-red-400">
            {warnings.length} DETECTED
          </span>
        </div>
      </div>

      {/* Issues List - Accordion Style */}
      <div className="space-y-2">
        {warnings.map((warning, index) => {
          const config = severityConfig[warning.severity];
          const Icon = config.icon;
          const isExpanded = expandedId === index;
          const educationalContent = getEducationalContent(warning.message, warning.category);

          return (
            <div 
              key={index} 
              className={`
                rounded-xl border transition-all duration-300 motion-safe:transition-all
                ${isExpanded 
                  ? `bg-white/[0.04] ${config.borderColor}` 
                  : 'bg-white/[0.02] border-white/[0.06] hover:bg-white/[0.04]'}
                ${config.glowColor} hover:shadow-lg
                cursor-pointer overflow-hidden
              `}
              onClick={() => toggleExpand(index)}
            >
              {/* Main Row - Always Visible */}
              <div className="flex items-center gap-4 p-4">
                {/* Icon */}
                <div className={`flex-shrink-0 w-10 h-10 rounded-xl ${config.iconBg} flex items-center justify-center border ${config.borderColor}`}>
                  <Icon className={`w-5 h-5 ${config.iconColor}`} />
                </div>

                {/* Content */}
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <span className={`text-xs font-semibold uppercase tracking-wider ${config.iconColor}`}>
                      {config.label}
                    </span>
                    <span className="text-xs text-white/20">‚Ä¢</span>
                    <span className="text-xs text-white/40 font-mono">
                      {warning.category}
                    </span>
                  </div>
                  <p className="text-sm text-white/70 line-clamp-1">{warning.message}</p>
                </div>

                {/* Expand Arrow */}
                <div className={`flex-shrink-0 w-8 h-8 rounded-lg bg-white/[0.03] flex items-center justify-center transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}>
                  <ChevronDown className="w-4 h-4 text-white/40" />
                </div>
              </div>

              {/* Expanded Section - Educational Content */}
              <div 
                className={`
                  overflow-hidden transition-all duration-300 ease-in-out
                  ${isExpanded ? 'max-h-60 opacity-100' : 'max-h-0 opacity-0'}
                `}
              >
                <div className="px-4 pb-4">
                  <div className="p-4 rounded-lg bg-white/[0.03] border border-white/[0.06]">
                    <div className="flex items-center gap-2 mb-3">
                      <div className="w-1.5 h-1.5 rounded-full bg-amber-400 animate-pulse" />
                      <span className="text-xs font-semibold uppercase tracking-wider text-amber-400/80">
                        Why This Matters
                      </span>
                    </div>
                    <p className="text-sm text-white/50 leading-relaxed font-light">
                      {educationalContent}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>

      {/* Footer Hint */}
      <div className="mt-4 text-center">
        <p className="text-xs text-white/30 italic">
          Intelligence data compiled from on-chain analysis ‚Ä¢ Educational purposes only
        </p>
      </div>
    </div>
  );
}
